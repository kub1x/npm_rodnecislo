'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RodneCislo = RodneCislo;
exports.rodnecislo = rodnecislo;
// rodnecislo.js
// version : 0.0.1
// authors : Jakub Podlaha
// license : MIT
// github.com/kub1x/rodnecislo

var GENDER = {
  MALE: 'MALE',
  FEMALE: 'FEMALE'
};

var MONTH_OFFSET = 1;
var DEFAULT_ADULTHOOD = 18;

function RodneCislo(value) {
  var _this = this;

  // PIN parts
  var _yy = void 0,
      _mm = void 0,
      _dd = void 0,
      _xxx = void 0,

  // Parsed birthdate
  _D = void 0,
      _M = void 0,
      _YYYY = void 0;
  // Gender
  var _gender = 'MALE';
  // PIN attributes
  var _longFormat = false;
  // Validation
  var _error = null;

  this.year = function () {
    return _YYYY;
  };
  this.month = function () {
    return _M;
  };
  this.day = function () {
    return _D;
  };

  this.birthDate = function () {
    return new Date(_YYYY, _M, _D);
  };
  this.birthDateAsString = function () {
    return _D + '.' + (_M + MONTH_OFFSET) + '.' + _YYYY;
  };

  this.dic = function () {
    return 'CZ' + _yy + _mm + _dd + _xxx;
  };

  this.gender = function () {
    return _gender;
  };
  this.isMale = function () {
    return _gender === GENDER.MALE;
  };
  this.isFemale = function () {
    return _gender === GENDER.FEMALE;
  };

  this.isValid = function () {
    return !_error;
  };
  this.error = function () {
    return _error;
  };

  this.isAdult = function () {
    var adulthood = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : DEFAULT_ADULTHOOD;
    return _this.age() >= adulthood;
  };

  this.age = function () {
    // Current date parsed (ignoring +1 timezone)
    var now = new Date();
    var CYYYY = now.getFullYear();
    var CM = now.getMonth();
    var CD = now.getDate();

    var age = CYYYY - _YYYY;

    if (CM > _M) {
      return age;
    }
    if (CM < _M) {
      return --age;
    }

    // We're on the MONTH of the bday.

    // NOTE In Czech you reach certain age at the beginning of your birthday.
    return CD >= _D ? age : --age;
  };

  /**
   * with OR without slash '/' between date part and distinction part
   * with 3 OR 4 digits of distinction part
   */
  var RODNECISLO_RE = /(\d\d)(\d\d)(\d\d)\/?(\d\d\d\d?)/;
  var MATCH_YY = 1;
  var MATCH_MM = 2;
  var MATCH_DD = 3;
  var MATCH_XX = 4;

  var LONG_XX_LENGTH = 4;

  var BEGIN = 0;
  var LAST = -1;

  var MODULO = 11;
  var MODULO_RESULT = 0;
  var MODULO_EXCEPTION_VALUE = 10;
  var MODULO_EXCEPTION_CHECK = 0;

  function parseRawInput(inputText) {
    var match = RODNECISLO_RE.exec(inputText);

    if (!match) {
      _error = 'Didn\'t match RegEx';
      return false;
    }

    _longFormat = match[MATCH_XX].length === LONG_XX_LENGTH;

    var whole = void 0,
        test = void 0,
        check = void 0;

    try {
      // Birth date parsed
      _yy = match[MATCH_YY];
      _mm = match[MATCH_MM];
      _dd = match[MATCH_DD];
      _xxx = match[MATCH_XX];

      if (_longFormat) {
        whole = '' + match[MATCH_YY] + match[MATCH_MM] + match[MATCH_DD] + match[MATCH_XX];
        test = +whole.slice(BEGIN, LAST); // all but last
        check = +whole.slice(LAST); // the last digit
        whole = +whole; // all of it
      }
    } catch (e) {
      _error = 'Failed to parse input string';
      return false;
    }

    if (_longFormat) {
      if (whole % MODULO === MODULO_RESULT) {
        // good old classic
      } else if (test % MODULO === MODULO_EXCEPTION_VALUE && check === MODULO_EXCEPTION_CHECK) {
        // the rare 1000 cases
      } else {
        _error = 'Failed the modulo condition';
        return false;
      }
    }
    return true;
  }

  var YEAR53 = 53;
  var CENT19 = 1900;
  var CENT20 = 2000;

  var WOMAN_MM_ADDITION = 50;
  var EXTRA_MM_ADDITION = 20;

  function isDateValid(y, m, d) {
    var date = new Date(y, m, d);
    var convertedDate = '' + date.getFullYear() + date.getMonth() + date.getDate();
    var givenDate = '' + y + m + d;

    return givenDate === convertedDate;
  }

  function parseBirthDate() {
    // Year
    _YYYY = +_yy;
    if (!_longFormat && _YYYY <= YEAR53) {
      // since ever - 31.12.1953
      _YYYY += CENT19;
    } else if (_longFormat && _YYYY > YEAR53) {
      // 1.1.1954 - 31.12.1999
      _YYYY += CENT19;
    } else if (_longFormat && _YYYY <= YEAR53) {
      // 1.1.2000 - 31.12.2053
      _YYYY += CENT20;
    } else {
      // NOTE This never happends as it would be the same as for 1954-2000
      // 1.1.2054 - until ever
      _error = 'We didn\'t think about this yet...';
      return false;
    }

    // Month and Gender
    _M = +_mm;

    // Women have month + 50
    if (_M > WOMAN_MM_ADDITION) {
      _gender = GENDER.FEMALE;
      _M %= WOMAN_MM_ADDITION;
    }

    // Sometimes men/women get extra month + 20
    _M %= EXTRA_MM_ADDITION;

    // Ok
    _M -= MONTH_OFFSET;
    _D = +_dd;

    // Final birthdate validation
    if (!isDateValid(_YYYY, _M, _D)) {
      _error = 'Invalid birth date';
      return false;
    }

    return true;
  }

  parseRawInput(value);
  parseBirthDate();

  return this;
} // RodneCislo

function rodnecislo(value) {
  return new RodneCislo(value);
}

rodnecislo.version = '0.0.2';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9saWIvcm9kbmVjaXNsby5qcyJdLCJuYW1lcyI6WyJSb2RuZUNpc2xvIiwicm9kbmVjaXNsbyIsIkdFTkRFUiIsIk1BTEUiLCJGRU1BTEUiLCJNT05USF9PRkZTRVQiLCJERUZBVUxUX0FEVUxUSE9PRCIsInZhbHVlIiwiX3l5IiwiX21tIiwiX2RkIiwiX3h4eCIsIl9EIiwiX00iLCJfWVlZWSIsIl9nZW5kZXIiLCJfbG9uZ0Zvcm1hdCIsIl9lcnJvciIsInllYXIiLCJtb250aCIsImRheSIsImJpcnRoRGF0ZSIsIkRhdGUiLCJiaXJ0aERhdGVBc1N0cmluZyIsImRpYyIsImdlbmRlciIsImlzTWFsZSIsImlzRmVtYWxlIiwiaXNWYWxpZCIsImVycm9yIiwiaXNBZHVsdCIsImFkdWx0aG9vZCIsImFnZSIsIm5vdyIsIkNZWVlZIiwiZ2V0RnVsbFllYXIiLCJDTSIsImdldE1vbnRoIiwiQ0QiLCJnZXREYXRlIiwiUk9ETkVDSVNMT19SRSIsIk1BVENIX1lZIiwiTUFUQ0hfTU0iLCJNQVRDSF9ERCIsIk1BVENIX1hYIiwiTE9OR19YWF9MRU5HVEgiLCJCRUdJTiIsIkxBU1QiLCJNT0RVTE8iLCJNT0RVTE9fUkVTVUxUIiwiTU9EVUxPX0VYQ0VQVElPTl9WQUxVRSIsIk1PRFVMT19FWENFUFRJT05fQ0hFQ0siLCJwYXJzZVJhd0lucHV0IiwiaW5wdXRUZXh0IiwibWF0Y2giLCJleGVjIiwibGVuZ3RoIiwid2hvbGUiLCJ0ZXN0IiwiY2hlY2siLCJzbGljZSIsImUiLCJZRUFSNTMiLCJDRU5UMTkiLCJDRU5UMjAiLCJXT01BTl9NTV9BRERJVElPTiIsIkVYVFJBX01NX0FERElUSU9OIiwiaXNEYXRlVmFsaWQiLCJ5IiwibSIsImQiLCJkYXRlIiwiY29udmVydGVkRGF0ZSIsImdpdmVuRGF0ZSIsInBhcnNlQmlydGhEYXRlIiwidmVyc2lvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFjZ0JBLFUsR0FBQUEsVTtRQW9MQUMsVSxHQUFBQSxVO0FBbE1oQjtB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QUFVYixPQUFPRSxNQUFqQjtBQUNBUyxZQUFNb0QsaUJBQU47QUFDRDs7QUFFRDtBQUNBcEQsVUFBTXFELGlCQUFOOztBQUVBO0FBQ0FyRCxVQUFNUixZQUFOO0FBQ0FPLFNBQUssQ0FBQ0YsR0FBTjs7QUFFQTtBQUNBLFFBQUksQ0FBQ3lELFlBQVlyRCxLQUFaLEVBQW1CRCxFQUFuQixFQUF1QkQsRUFBdkIsQ0FBTCxFQUFpQztBQUMvQkssZUFBUyxvQkFBVDtBQUNBLGFBQU8sS0FBUDtBQUNEOztBQUVELFdBQU8sSUFBUDtBQUNEOztBQUVEbUMsZ0JBQWM3QyxLQUFkO0FBQ0FtRTs7QUFFQSxTQUFPLElBQVA7QUFFRCxDLENBQUM7O0FBRUssU0FBU3pFLFVBQVQsQ0FBb0JNLEtBQXBCLEVBQTJCO0FBQ2hDLFNBQU8sSUFBSVAsVUFBSixDQUFlTyxLQUFmLENBQVA7QUFDRDs7QUFFRE4sV0FBVzBFLE9BQVgsR0FBcUIsT0FBckIiLCJmaWxlIjoicm9kbmVjaXNsby5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHJvZG5lY2lzbG8uanNcbi8vIHZlcnNpb24gOiAwLjAuMVxuLy8gYXV0aG9ycyA6IEpha3ViIFBvZGxhaGFcbi8vIGxpY2Vuc2UgOiBNSVRcbi8vIGdpdGh1Yi5jb20va3ViMXgvcm9kbmVjaXNsb1xuXG5jb25zdCBHRU5ERVIgPSB7XG4gIE1BTEU6ICdNQUxFJyxcbiAgRkVNQUxFOiAnRkVNQUxFJ1xufTtcblxuY29uc3QgTU9OVEhfT0ZGU0VUID0gMTtcbmNvbnN0IERFRkFVTFRfQURVTFRIT09EID0gMTg7XG5cbmV4cG9ydCBmdW5jdGlvbiBSb2RuZUNpc2xvKHZhbHVlKSB7XG5cbiAgLy8gUElOIHBhcnRzXG4gIGxldCBfeXksIF9tbSwgX2RkLCBfeHh4LFxuICAvLyBQYXJzZWQgYmlydGhkYXRlXG4gICAgX0QsIF9NLCBfWVlZWTtcbiAgLy8gR2VuZGVyXG4gIGxldCBfZ2VuZGVyID0gJ01BTEUnO1xuICAvLyBQSU4gYXR0cmlidXRlc1xuICBsZXQgX2xvbmdGb3JtYXQgPSBmYWxzZTtcbiAgLy8gVmFsaWRhdGlvblxuICBsZXQgX2Vycm9yID0gbnVsbDtcblxuICB0aGlzLnllYXIgPSAoKSA9PiBfWVlZWTtcbiAgdGhpcy5tb250aCA9ICgpID0+IF9NO1xuICB0aGlzLmRheSA9ICgpID0+IF9EO1xuXG4gIHRoaXMuYmlydGhEYXRlID0gKCkgPT4gbmV3IERhdGUoX1lZWVksIF9NLCBfRCk7XG4gIHRoaXMuYmlydGhEYXRlQXNTdHJpbmcgPSAoKSA9PiBgJHtfRH0uJHtfTSArIE1PTlRIX09GRlNFVH0uJHtfWVlZWX1gO1xuXG4gIHRoaXMuZGljID0gKCkgPT4gYENaJHtfeXl9JHtfbW19JHtfZGR9JHtfeHh4fWA7XG5cbiAgdGhpcy5nZW5kZXIgPSAoKSA9PiBfZ2VuZGVyO1xuICB0aGlzLmlzTWFsZSA9ICgpID0+IF9nZW5kZXIgPT09IEdFTkRFUi5NQUxFO1xuICB0aGlzLmlzRmVtYWxlID0gKCkgPT4gX2dlbmRlciA9PT0gR0VOREVSLkZFTUFMRTtcblxuICB0aGlzLmlzVmFsaWQgPSAoKSA9PiAhX2Vycm9yO1xuICB0aGlzLmVycm9yID0gKCkgPT4gX2Vycm9yO1xuXG4gIHRoaXMuaXNBZHVsdCA9IChhZHVsdGhvb2QgPSBERUZBVUxUX0FEVUxUSE9PRCkgPT4gdGhpcy5hZ2UoKSA+PSBhZHVsdGhvb2Q7XG5cbiAgdGhpcy5hZ2UgPSAoKSA9PiB7XG4gICAgLy8gQ3VycmVudCBkYXRlIHBhcnNlZCAoaWdub3JpbmcgKzEgdGltZXpvbmUpXG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBDWVlZWSA9IG5vdy5nZXRGdWxsWWVhcigpO1xuICAgIGNvbnN0IENNID0gbm93LmdldE1vbnRoKCk7XG4gICAgY29uc3QgQ0QgPSBub3cuZ2V0RGF0ZSgpO1xuXG4gICAgbGV0IGFnZSA9IENZWVlZIC0gX1lZWVk7XG5cbiAgICBpZiAoQ00gPiBfTSkgeyByZXR1cm4gYWdlOyB9XG4gICAgaWYgKENNIDwgX00pIHsgcmV0dXJuIC0tYWdlOyB9XG5cbiAgICAvLyBXZSdyZSBvbiB0aGUgTU9OVEggb2YgdGhlIGJkYXkuXG5cbiAgICAvLyBOT1RFIEluIEN6ZWNoIHlvdSByZWFjaCBjZXJ0YWluIGFnZSBhdCB0aGUgYmVnaW5uaW5nIG9mIHlvdXIgYmlydGhkYXkuXG4gICAgcmV0dXJuIChDRCA+PSBfRCkgPyBhZ2UgOiAtLWFnZTtcbiAgfTtcblxuXG4gIC8qKlxuICAgKiB3aXRoIE9SIHdpdGhvdXQgc2xhc2ggJy8nIGJldHdlZW4gZGF0ZSBwYXJ0IGFuZCBkaXN0aW5jdGlvbiBwYXJ0XG4gICAqIHdpdGggMyBPUiA0IGRpZ2l0cyBvZiBkaXN0aW5jdGlvbiBwYXJ0XG4gICAqL1xuICBjb25zdCBST0RORUNJU0xPX1JFID0gLyhcXGRcXGQpKFxcZFxcZCkoXFxkXFxkKVxcLz8oXFxkXFxkXFxkXFxkPykvO1xuICBjb25zdCBNQVRDSF9ZWSA9IDE7XG4gIGNvbnN0IE1BVENIX01NID0gMjtcbiAgY29uc3QgTUFUQ0hfREQgPSAzO1xuICBjb25zdCBNQVRDSF9YWCA9IDQ7XG5cbiAgY29uc3QgTE9OR19YWF9MRU5HVEggPSA0O1xuXG4gIGNvbnN0IEJFR0lOID0gMDtcbiAgY29uc3QgTEFTVCA9IC0xO1xuXG4gIGNvbnN0IE1PRFVMTyA9IDExO1xuICBjb25zdCBNT0RVTE9fUkVTVUxUID0gMDtcbiAgY29uc3QgTU9EVUxPX0VYQ0VQVElPTl9WQUxVRSA9IDEwO1xuICBjb25zdCBNT0RVTE9fRVhDRVBUSU9OX0NIRUNLID0gMDtcblxuICBmdW5jdGlvbiBwYXJzZVJhd0lucHV0KGlucHV0VGV4dCkge1xuICAgIGNvbnN0IG1hdGNoID0gUk9ETkVDSVNMT19SRS5leGVjKGlucHV0VGV4dCk7XG5cbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICBfZXJyb3IgPSAnRGlkblxcJ3QgbWF0Y2ggUmVnRXgnO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIF9sb25nRm9ybWF0ID0gbWF0Y2hbTUFUQ0hfWFhdLmxlbmd0aCA9PT0gTE9OR19YWF9MRU5HVEg7XG5cbiAgICBsZXQgd2hvbGUsIHRlc3QsIGNoZWNrO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEJpcnRoIGRhdGUgcGFyc2VkXG4gICAgICBfeXkgPSBtYXRjaFtNQVRDSF9ZWV07XG4gICAgICBfbW0gPSBtYXRjaFtNQVRDSF9NTV07XG4gICAgICBfZGQgPSBtYXRjaFtNQVRDSF9ERF07XG4gICAgICBfeHh4ID0gbWF0Y2hbTUFUQ0hfWFhdO1xuXG4gICAgICBpZiAoX2xvbmdGb3JtYXQpIHtcbiAgICAgICAgd2hvbGUgPSBgJHttYXRjaFtNQVRDSF9ZWV19JHttYXRjaFtNQVRDSF9NTV19JHttYXRjaFtNQVRDSF9ERF19JHttYXRjaFtNQVRDSF9YWF19YDtcbiAgICAgICAgdGVzdCA9ICt3aG9sZS5zbGljZShCRUdJTiwgTEFTVCk7IC8vIGFsbCBidXQgbGFzdFxuICAgICAgICBjaGVjayA9ICt3aG9sZS5zbGljZShMQVNUKTsgLy8gdGhlIGxhc3QgZGlnaXRcbiAgICAgICAgd2hvbGUgPSArd2hvbGU7IC8vIGFsbCBvZiBpdFxuICAgICAgfVxuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgX2Vycm9yID0gJ0ZhaWxlZCB0byBwYXJzZSBpbnB1dCBzdHJpbmcnO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChfbG9uZ0Zvcm1hdCkge1xuICAgICAgaWYgKHdob2xlICUgTU9EVUxPID09PSBNT0RVTE9fUkVTVUxUKSB7XG4gICAgICAgIC8vIGdvb2Qgb2xkIGNsYXNzaWNcbiAgICAgIH0gZWxzZSBpZiAodGVzdCAlIE1PRFVMTyA9PT0gTU9EVUxPX0VYQ0VQVElPTl9WQUxVRSAmJiBjaGVjayA9PT0gTU9EVUxPX0VYQ0VQVElPTl9DSEVDSykge1xuICAgICAgICAvLyB0aGUgcmFyZSAxMDAwIGNhc2VzXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBfZXJyb3IgPSAnRmFpbGVkIHRoZSBtb2R1bG8gY29uZGl0aW9uJztcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGNvbnN0IFlFQVI1MyA9IDUzO1xuICBjb25zdCBDRU5UMTkgPSAxOTAwO1xuICBjb25zdCBDRU5UMjAgPSAyMDAwO1xuXG4gIGNvbnN0IFdPTUFOX01NX0FERElUSU9OID0gNTA7XG4gIGNvbnN0IEVYVFJBX01NX0FERElUSU9OID0gMjA7XG5cbiAgZnVuY3Rpb24gaXNEYXRlVmFsaWQoeSwgbSwgZCkge1xuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh5LCBtLCBkKTtcbiAgICBjb25zdCBjb252ZXJ0ZWREYXRlID0gYCR7ZGF0ZS5nZXRGdWxsWWVhcigpfSR7ZGF0ZS5nZXRNb250aCgpfSR7ZGF0ZS5nZXREYXRlKCl9YDtcbiAgICBjb25zdCBnaXZlbkRhdGUgPSBgJHt5fSR7bX0ke2R9YDtcblxuICAgIHJldHVybiAoZ2l2ZW5EYXRlID09PSBjb252ZXJ0ZWREYXRlKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhcnNlQmlydGhEYXRlKCkge1xuICAgIC8vIFllYXJcbiAgICBfWVlZWSA9ICtfeXk7XG4gICAgaWYgKCFfbG9uZ0Zvcm1hdCAmJiBfWVlZWSA8PSBZRUFSNTMpIHtcbiAgICAgIC8vIHNpbmNlIGV2ZXIgLSAzMS4xMi4xOTUzXG4gICAgICBfWVlZWSArPSBDRU5UMTk7XG4gICAgfSBlbHNlIGlmIChfbG9uZ0Zvcm1hdCAmJiBfWVlZWSA+IFlFQVI1Mykge1xuICAgICAgLy8gMS4xLjE5NTQgLSAzMS4xMi4xOTk5XG4gICAgICBfWVlZWSArPSBDRU5UMTk7XG4gICAgfSBlbHNlIGlmIChfbG9uZ0Zvcm1hdCAmJiBfWVlZWSA8PSBZRUFSNTMpIHtcbiAgICAgIC8vIDEuMS4yMDAwIC0gMzEuMTIuMjA1M1xuICAgICAgX1lZWVkgKz0gQ0VOVDIwO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBOT1RFIFRoaXMgbmV2ZXIgaGFwcGVuZHMgYXMgaXQgd291bGQgYmUgdGhlIHNhbWUgYXMgZm9yIDE5NTQtMjAwMFxuICAgICAgLy8gMS4xLjIwNTQgLSB1bnRpbCBldmVyXG4gICAgICBfZXJyb3IgPSAnV2UgZGlkblxcJ3QgdGhpbmsgYWJvdXQgdGhpcyB5ZXQuLi4nO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIE1vbnRoIGFuZCBHZW5kZXJcbiAgICBfTSA9ICtfbW07XG5cbiAgICAvLyBXb21lbiBoYXZlIG1vbnRoICsgNTBcbiAgICBpZiAoX00gPiBXT01BTl9NTV9BRERJVElPTikge1xuICAgICAgX2dlbmRlciA9IEdFTkRFUi5GRU1BTEU7XG4gICAgICBfTSAlPSBXT01BTl9NTV9BRERJVElPTjtcbiAgICB9XG5cbiAgICAvLyBTb21ldGltZXMgbWVuL3dvbWVuIGdldCBleHRyYSBtb250aCArIDIwXG4gICAgX00gJT0gRVhUUkFfTU1fQURESVRJT047XG5cbiAgICAvLyBPa1xuICAgIF9NIC09IE1PTlRIX09GRlNFVDtcbiAgICBfRCA9ICtfZGQ7XG5cbiAgICAvLyBGaW5hbCBiaXJ0aGRhdGUgdmFsaWRhdGlvblxuICAgIGlmICghaXNEYXRlVmFsaWQoX1lZWVksIF9NLCBfRCkpIHtcbiAgICAgIF9lcnJvciA9ICdJbnZhbGlkIGJpcnRoIGRhdGUnO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcGFyc2VSYXdJbnB1dCh2YWx1ZSk7XG4gIHBhcnNlQmlydGhEYXRlKCk7XG5cbiAgcmV0dXJuIHRoaXM7XG5cbn0gLy8gUm9kbmVDaXNsb1xuXG5leHBvcnQgZnVuY3Rpb24gcm9kbmVjaXNsbyh2YWx1ZSkge1xuICByZXR1cm4gbmV3IFJvZG5lQ2lzbG8odmFsdWUpO1xufVxuXG5yb2RuZWNpc2xvLnZlcnNpb24gPSAnMC4wLjInO1xuIl19